<?xml version="1.0" encoding="utf-8" ?>
<sqlMap namespace="LineItem"
xmlns="http://ibatis.apache.org/mapping"
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" >
  <alias>
    <typeAlias alias="Ventas_Lunes"   type="Poleo.Objects.Ventas_Lunes" />
    <typeAlias alias="VentasFinderr"   type="Poleo.Objects.VentasFinder" />
    
  </alias>
  <statements>

    <select id="SelectVentasLunes" parameterClass="VentasFinderr" resultClass="Ventas_Lunes">
      SELECT
      Tiendas.Nombre_tienda AS Nombre_tienda2
      ,Location_Code AS Tienda2
      ,System_Date AS FechaVenta2
      ,CAST(Total_Sales as decimal(12,2)) AS VentasConImpuesto2
      ,CAST(Sales_Tax as decimal(12,2)) AS Impuesto2
      ,DATEPART(ISO_WEEK, System_Date) as NumSemana2
      ,CASE  when DATEPART(dw,Ventas.System_Date)=1  then 7 else DATEPART(dw,Ventas.System_Date)-1 end  AS NumDia2
      FROM Ventas
      INNER JOIN Tiendas  ON  Ventas.Location_Code = Tiendas.Number_tienda


      WHERE System_Date BETWEEN  #DateIni# AND #DateEnd#
      <isNotEmpty prepend="AND" property="NumTienda" >
        Tiendas.Number_tienda= #NumTienda#
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TipoTienda" >
        Tiendas.Tipo= #TipoTienda#
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="UbicacionTienda" >
        Tiendas.Ubicacion = #UbicacionTienda#
      </isNotEmpty>
      <!--order by Location_Code, EndDate-->
      order by Code, System_Date

    </select>

    <select id="SelectVentasLunesTotal" parameterClass="VentasFinderr" resultClass="Ventas_Lunes">
      SELECT
      System_Date AS FechaVenta2
      ,SUM(Total_Sales) AS VentasConImpuesto2
      ,SUM(Sales_Tax)	AS Impuesto2
      ,DATEPART(ISO_WEEK, System_Date) as NumSemana2
      ,CASE  when DATEPART(dw,Ventas.System_Date)=1  then 7 else DATEPART(dw,Ventas.System_Date)-1 end  AS NumDia2
      FROM Ventas
      INNER JOIN Tiendas  ON  Ventas.Location_Code = Tiendas.Number_tienda
      WHERE System_Date BETWEEN  #DateIni# AND #DateEnd#
      <isNotEmpty prepend="AND" property="NumTienda" >
        Tiendas.Number_tienda= #NumTienda#
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TipoTienda" >
        Tiendas.Tipo= #TipoTienda#
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="UbicacionTienda" >
        Tiendas.Ubicacion = #UbicacionTienda#
      </isNotEmpty>
      <!--order by Location_Code, EndDate-->
      Group by System_Date
    </select>

    <select id="SelectVentasLunes2" parameterClass="VentasFinderr" resultClass="Ventas_Lunes">
      SELECT
      KeysCorp.EndDate            AS  FechaVenta2
      ,KeysCorp.Location_Code      AS  Tienda2
      ,KeysCorp.Net_Sales          AS  VentasReales2
      ,CASE  when DATEPART(dw,KeysCorp.EndDate)=1  then 7 else DATEPART(dw,KeysCorp.EndDate)-1 end  AS NumDia2
      , DATEPART(ISO_WEEK, KeysCorp.EndDate) as NumSemana2
      FROM KeysExtractsCorpVersion AS KeysCorp
      INNER JOIN Tiendas AS T ON T.Number_tienda=KeysCorp.Location_Code

      WHERE KeysCorp.EndDate BETWEEN  #DateIni# AND #DateEnd#
      <isNotEmpty prepend="AND" property="NumTienda" >
        KeysCorp.Location_Code= #NumTienda#
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TipoTienda" >
        T.Tipo= #TipoTienda#
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="UbicacionTienda" >
        T.Ubicacion = #UbicacionTienda#
      </isNotEmpty>
      ORDER BY Code,FechaVenta2

    </select>

    <select id="SelectVentasLunesTotal2" parameterClass="VentasFinderr" resultClass="Ventas_Lunes">
      DECLARE @tblVentas TABLE
      (
      FechaVenta2 Datetime
      ,VentasReales2 Money
      )

      insert @tblVentas
      SELECT
      EndDate            AS  FechaVenta2
      ,SUM(Net_Sales)          AS  VentasReales2
      FROM KeysExtractsCorpVersion AS KeysCorp
      INNER JOIN Tiendas AS T ON T.Number_tienda=KeysCorp.Location_Code
      WHERE EndDate BETWEEN  #DateIni# AND #DateEnd#
      <isNotEmpty prepend="AND" property="NumTienda" >
        Location_Code= #NumTienda#
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TipoTienda" >
        T.Tipo= #TipoTienda#
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="UbicacionTienda" >
        T.Ubicacion = #UbicacionTienda#
      </isNotEmpty>
      GROUP BY EndDate


      SELECT
      V.*
      ,CASE  when DATEPART(dw,V.FechaVenta2)=1  then 7 else DATEPART(dw,V.FechaVenta2)-1 end  AS NumDia2
      , DATEPART(ISO_WEEK, V.FechaVenta2) as NumSemana2
      FROM @tblVentas V
    </select>
    
  </statements>
</sqlMap>
