<?xml version="1.0" encoding="utf-8" ?>
<sqlMap namespace="LineItem"
xmlns="http://ibatis.apache.org/mapping"
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" >
  <alias>
    <typeAlias alias="OrdenesFinder" type="Poleo.Objects.OrdenesFinder" />
    <typeAlias alias="OrdenDetalle" type="Poleo.Objects.OrderDetail" />
  </alias>
  <statements>
    <select id="selectOrdenesPorCupon" parameterClass="OrdenesFinder" resultClass="OrdenDetalle">
      declare @ordenesCupon table (
      numeroOrden int,
      tienda varchar(10)
      )
      insert @ordenesCupon
      select  distinct  ORD.Ord_No, ORD.Store_No from OrderDetailsExtracts  ORD
      INNER JOIN  Tiendas T ON T.Number_tienda=ORD.Store_No
      where <!--Cpn_Cd=#CodigoCupon#-->
      Ord_Dt between #DateIni# and #DateEnd#
      <isNotEmpty prepend="AND" property="NumTienda" >
        T.Number_tienda= #NumTienda#
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TipoTienda" >
        T.Tipo= #TipoTienda#
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="UbicacionTienda" >
        T.Ubicacion = #UbicacionTienda#
      </isNotEmpty>
      <isNull property="LstCuponCode">
        <isNotEmpty prepend="AND" property="CodigoCupon" >
          Cpn_Cd = #CodigoCupon#
        </isNotEmpty>
      </isNull>
      <isNotNull prepend="AND" property="LstCuponCode">
        Cpn_Cd IN
        <iterate property="LstCuponCode" open="(" close=")" conjunction=",">
           #LstCuponCode[]#
        </iterate>
      </isNotNull>


      select od.* from OrderDetailsExtracts OD
      inner join @ordenesCupon OC on oc.numeroOrden=od.Ord_No and OC.tienda= OD.Store_No
    </select>

    
      
   
  </statements>
</sqlMap>
