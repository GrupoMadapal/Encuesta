<?xml version="1.0" encoding="utf-8" ?>
<sqlMap namespace="LineItem"
xmlns="http://ibatis.apache.org/mapping"
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" >
  <alias>
    <typeAlias alias="InformacionOperativa" type="Poleo.Objects.InformacionOperativa" />
    <typeAlias alias="FinderInformacionOp" type="Poleo.Objects.VentasFinder" />
    <typeAlias alias="OrderbyTime" type="Poleo.Objects.OrderbyTime" />
  </alias>
  <statements>
    <select id="SelectTiemposPromedio" parameterClass="FinderInformacionOp" resultClass="InformacionOperativa">
       <!--SELECT
      SUM(Ave_Take_Minutes)/COUNT(Ave_Take_Hms) AS TomaOrden,
      SUM(Ave_Load_Minutes)/COUNT(Ave_Load_Hms) AS Produccion,
      SUM(Ave_Wait_Minutes)/COUNT(Ave_Wait_Hms) AS Repisa,
      SUM(Ave_Dispatch_Minutes)/COUNT(Ave_Dispatch_Hms) as FueraTienda,
      SUM(Ave_Delivery_Minutes)/COUNT(Ave_Delivery_Hms) AS Entrega
      FROM KeysExtractsCorpVersion as KeysCorp
      inner join Tiendas as T on T.Number_tienda=KeysCorp.Location_Code
      where EndDate between #DateIni# AND #DateEnd#-->
      <!--SELECT
      Ave_Take_Minutes AS TomaOrden,
      Ave_Load_Minutes AS Produccion,
      Ave_Wait_Minutes AS Repisa,
      Ave_Dispatch_Minutes AS FueraTienda,
      Ave_Delivery_Minutes AS Entrega
      FROM KeysExtractsCorpVersion as KeysCorp
      inner join Tiendas as T on T.Number_tienda=KeysCorp.Location_Code
      where EndDate between #DateIni# AND #DateEnd#-->
      <!--SELECT CAST(CAST(SUM(Take_Tm) AS DECIMAL(12,2))/CAST(COUNT(Ord_No) AS DECIMAL(12,2)) AS DECIMAL(12,2)) AS TomaOrden,-->
      
      <!--<isNotEmpty prepend="AND" property="NumTienda" >
        Store_No = #NumTienda#
        --><!--Location_Code= #NumTienda#--><!--
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TipoTienda" >
        T.Tipo= #TipoTienda#
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="UbicacionTienda" >
        T.Ubicacion = #UbicacionTienda#
      </isNotEmpty>-->
      
      DECLARE @NumberStore VARCHAR(5) = #NumTienda#
      DECLARE @DateIni DATE = #DateIni#
      DECLARE @DateEnd DATE = #DateEnd#

      DECLARE @TO DECIMAL(12,2)
      DECLARE @P DECIMAL(12,2)
      DECLARE @R DECIMAL(12,2)
      DECLARE @FT DECIMAL(12,2)
      DECLARE @ET DECIMAL(12,2)

      /*****************************   TOMA DE ORDEN   *********************************/
      SELECT @TO = CAST(SUM(Take_Tm)/COUNT(Ord_No) AS DECIMAL(12,2))
      FROM OrdersExtracts
      WHERE Store_No = @NumberStore AND Ord_Dt BETWEEN @DateIni AND @DateEnd AND Pulse_Order_Status_Code NOT IN (100,103,102) AND Order_Source != 'Web'

      /*****************************   PRODUCCION   ********************************/
      SELECT @P = SUM(Load_Time_Secs)/COUNT(Ord_No)
      FROM OrdersExtracts
      WHERE Store_No = @NumberStore AND Ord_Dt BETWEEN @DateIni AND @DateEnd AND Pulse_Order_Status_Code NOT IN (100,103,102) AND Load_Time_Secs > 0

      /*****************************   REPISA   ******************************************/
      SELECT @R = SUM(OrderRackTimeSecs)/COUNT(Order_Number)
      FROM OrdersDump
      WHERE Location_Code = @NumberStore AND Order_Date BETWEEN @DateIni AND @DateEnd AND Order_Status_Code <![CDATA[<=]]> 100 AND OrderDeliveryTimeSecs IS NOT NULL
      AND Order_Type_Code = 'D'

      /********************************** FUERA DE TIENDA********************************************/
      DECLARE @pr BIT = 0

      SELECT Order_Number,
      CASE WHEN @pr = 1 AND OutboundDriveTimeSecs IS NOT NULL THEN DATEDIFF(ss, Route_Time, CalculatedReturnTime)
      ELSE DATEDIFF(ss, Route_Time, Return_Time) END AS RunTime
      INTO ##TEMPTBLRT
      FROM OrdersDump
      WHERE Location_Code = @NumberStore AND Order_Date BETWEEN @DateIni AND @DateEnd AND Order_Status_Code <![CDATA[<]]> 100 AND OrderDeliveryTimeSecs IS NOT NULL

      SELECT @FT = sum(RunTime)/count(Order_Number) FROM ##TEMPTBLRT
      WHERE RunTime > 0

      DROP TABLE ##TEMPTBLRT

      /********************************** ESTIMADO DE ENTREGA **********************************************/

      SELECT Order_Number,
      CASE WHEN @pr = 1 AND CalculatedDeliveryTimeSecs IS NOT NULL
      THEN CalculatedDeliveryTimeSecs
      ELSE OrderDeliveryTimeSecs END AS 'Delivery'
      INTO ##TBLTEMPDT
      FROM OrdersDump
      WHERE Location_Code = @NumberStore AND Order_Date BETWEEN @DateIni AND @DateEnd AND Order_Status_Code <![CDATA[<=]]> 100 AND OrderDeliveryTimeSecs IS NOT NULL

      SELECT @ET = SUM(Delivery)/COUNT(Order_Number) FROM ##TBLTEMPDT
      WHERE Delivery > 0

      DROP TABLE ##TBLTEMPDT


      SELECT @TO AS TomaOrden,@P AS Produccion,@R AS Repisa,@FT AS FueraTienda,@ET AS Entrega

    </select>
    <select id="SelectOrderbyTime" parameterClass="FinderInformacionOp" resultClass="OrderbyTime">
      <![CDATA[
      SELECT
      SUM(CASE WHEN DATEDIFF(second,Ord_Hms ,Disp_Hms) >0 AND DATEDIFF(second,Ord_Hms ,Disp_Hms)<=900 THEN 1 ELSE 0 END)AS Ord_Less_15,
      SUM(CASE WHEN Delv_Tm >0 AND Delv_Tm<=1800 THEN 1 ELSE 0 END)AS Ord_Less_30,
      SUM(CASE WHEN Delv_Tm >1800  THEN 1 ELSE 0 END)AS Ord_More_30,
      COUNT(*)AS Ord_Total
      ]]>
      FROM OrdersExtracts
      inner join Tiendas as T on T.Number_tienda=OrdersExtracts.Store_No
      WHERE Ord_Dt between #DateIni# AND #DateEnd#
      <isNotEmpty prepend="AND" property="NumTienda" >
        OrdersExtracts.Store_No= #NumTienda#
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TipoTienda" >
        T.Tipo= #TipoTienda#
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="UbicacionTienda" >
        T.Ubicacion = #UbicacionTienda#
      </isNotEmpty> AND Ord_Status_Cd LIKE 'G' AND Ord_Type_Cd LIKE  'D'
      
    </select>
  </statements>
</sqlMap>
