<?xml version="1.0" encoding="utf-8" ?>
<sqlMap namespace="LineItem"
xmlns="http://ibatis.apache.org/mapping"
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" >
  <alias>
    <typeAlias alias="DQ_Indicador" type="Poleo.Objects.DQ_Indicador"/>
  </alias>

  <statements>
    <select id="SelectSalesWeek" parameterClass="DQ_VentasFinder" resultClass="DQ_Indicador">
      SELECT
      CAST(SUM(TOTALNETO) AS DECIMAL(12,2)) AS TotalSales,
      SUM(CASE WHEN TOTALNETO > 0 THEN 1 WHEN TOTALNETO = 0 THEN -1 ELSE -2 END) AS Transactions,
      SUBSTRING(NUMSERIE,1,2) AS NumberStore
      INTO ##SALES
      FROM ALBVENTACAB
      WHERE SUBSTRING(NUMSERIE,1,2) LIKE #Sucursal# AND NUMSERIE NOT LIKE '%I' AND FECHA BETWEEN #FechaIni# AND #FechaEnd#
      GROUP BY SUBSTRING(NUMSERIE,1,2)

      SELECT
      CAST(SUM(IMPORTE) AS DECIMAL(12,2)) AS Target,
      SUBSTRING(SERIE,1,2) AS NumberStore
      INTO ##TARJETA
      FROM TESORERIA
      WHERE SUBSTRING(SERIE,1,2) LIKE #Sucursal# AND FECHADOCUMENTO BETWEEN #FechaIni# AND #FechaEnd# AND CODTIPOPAGO = 3
      GROUP BY SUBSTRING(SERIE,1,2)

      SELECT
      SUM(TOTALNETO) AS SalesLastWeek,
      SUM(CASE WHEN TOTALNETO > 0 THEN 1 WHEN TOTALNETO = 0 THEN -1 ELSE -2 END) AS TransactionsLastWeek,
      SUBSTRING(NUMSERIE,1,2) AS NumberStore
      INTO ##SALESLASTWEEK
      FROM ALBVENTACAB
      WHERE SUBSTRING(NUMSERIE,1,2) LIKE #Sucursal# AND NUMSERIE NOT LIKE '%I' AND FECHA BETWEEN #DateIniLastWeek# AND #DateEndLastWeek#
      GROUP BY SUBSTRING(NUMSERIE,1,2)

      SELECT
      SUM(TOTALNETO) AS SalesLastYear,
      SUM(CASE WHEN TOTALNETO > 0 THEN 1 WHEN TOTALNETO = 0 THEN -1 ELSE -2 END) AS TransactionsLastYear,
      SUBSTRING(NUMSERIE,1,2) AS NumberStore
      INTO ##SALESLASTYEAR
      FROM ALBVENTACAB
      WHERE SUBSTRING(NUMSERIE,1,2) LIKE #Sucursal# AND NUMSERIE NOT LIKE '%I' AND FECHA BETWEEN #DateIniLastYear# AND #DateEndLastYear#
      GROUP BY SUBSTRING(NUMSERIE,1,2)

      SELECT
      S.TotalSales,
      S.Transactions,
      SLW.SalesLastWeek,
      SLW.TransactionsLastWeek,
      SLY.SalesLastYear,
      SLY.TransactionsLastYear,
      T.Target
      FROM ##SALES S
      LEFT JOIN ##SALESLASTWEEK SLW ON S.NumberStore = SLW.NumberStore
      LEFT JOIN ##TARJETA T ON SLW.NumberStore = T.NumberStore
      LEFT JOIN ##SALESLASTYEAR SLY ON T.NumberStore = SLY.NumberStore

      DROP TABLE ##SALES
      DROP TABLE ##SALESLASTWEEK
      DROP TABLE ##SALESLASTYEAR
      DROP TABLE ##TARJETA
    </select>

    <select id="SelectPurchaseInvoice" parameterClass="DQ_VentasFinder" resultClass="DQ_Indicador">
      SELECT CAST(TOTALNETO AS DECIMAL(12,2)) AS TotalPurchaseInvoice
      FROM ALBCOMPRACAB
      WHERE SUBSTRING(NUMSERIE,1,2) LIKE #Sucursal# AND FECHAALBARAN BETWEEN #FechaIni# AND #FechaEnd#
      ORDER BY CODPROVEEDOR
    </select>

    <select id="SelectCosteMerma" parameterClass="DQ_VentasFinder" resultClass="DQ_Indicador">
      SELECT
		  CAST(SUM(PRECIO * UNIDADES) AS DECIMAL(20,2)) AS TotalCosteMerma
	    FROM MOVIMENTS
	    wHERE FECHA BETWEEN #FechaIni# AND #FechaEnd# AND CODALMACENDESTINO = #AlmacenMerma#
    </select>

    <select id="SelectSalesDaily" parameterClass="DQ_VentasFinder" resultClass="DQ_Indicador">
      SELECT
      CAST(SUM(TOTALBRUTO) AS DECIMAL(20,2)) AS RealSales,
      CAST(SUM(CASE WHEN TOTALNETO > 0 THEN 1 WHEN TOTALNETO = 0 THEN -1 ELSE -2 END) AS DECIMAL(20,2)) AS Orders,
      CAST(SUM(TOTALCOSTE) AS DECIMAL(20,2)) AS CosteIdeal
      FROM ALBVENTACAB
      WHERE FECHA BETWEEN #FechaIni# AND #FechaEnd# AND NUMSERIE NOT LIKE '%I' AND SUBSTRING(NUMSERIE,1,2) LIKE #Sucursal#
      GROUP BY SUBSTRING(NUMSERIE,1,2), FECHA
	    ORDER BY FECHA
    </select>

    <select id="SelectTopProducts" paramterClass="DQ_VentasFinder" resultClass="DQ_Indicador">
      SELECT
      'Blizzard' AS Articulo,
      CAST(SUM(ALBVENTALIN.TOTAL) AS DECIMAL(12,2)) AS TotalSales,
      COUNT(ALBVENTALIN.CODARTICULO) AS Orders
      FROM ALBVENTALIN
      INNER JOIN ARTICULOS ON ALBVENTALIN.CODARTICULO = ARTICULOS.CODARTICULO
      WHERE HORA BETWEEN #FechaIni# AND DATEADD(DAY,1,#FechaEnd#) AND DPTO = '100' AND SUBSTRING(NUMSERIE,1,2) LIKE #Sucursal#
      UNION
      SELECT
      'Shakes' AS Articulo,
      CAST(SUM(ALBVENTALIN.TOTAL) AS DECIMAL(12,2)) AS TotalSales,
      COUNT(ALBVENTALIN.CODARTICULO) AS Orders
      FROM ALBVENTALIN
      INNER JOIN ARTICULOS ON ALBVENTALIN.CODARTICULO = ARTICULOS.CODARTICULO
      WHERE HORA BETWEEN #FechaIni# AND DATEADD(DAY,1,#FechaEnd#) AND DPTO = '1300' AND SUBSTRING(NUMSERIE,1,2) LIKE #Sucursal#
      UNION
      SELECT
      'Molate' AS Articulo,
      CAST(SUM(ALBVENTALIN.TOTAL) AS DECIMAL(12,2)) AS TotalSales,
      COUNT(ALBVENTALIN.CODARTICULO) AS Orders
      FROM ALBVENTALIN
      INNER JOIN ARTICULOS ON ALBVENTALIN.CODARTICULO = ARTICULOS.CODARTICULO
      WHERE HORA BETWEEN #FechaIni# AND DATEADD(DAY,1,#FechaEnd#) AND DPTO = '1600' AND SUBSTRING(NUMSERIE,1,2) LIKE #Sucursal#
      UNION
      SELECT
      'Conos' AS Articulo,
      CAST(SUM(ALBVENTALIN.TOTAL) AS DECIMAL(12,2)) AS TotalSales,
      COUNT(ALBVENTALIN.CODARTICULO) AS Orders
      FROM ALBVENTALIN
      INNER JOIN ARTICULOS ON ALBVENTALIN.CODARTICULO = ARTICULOS.CODARTICULO
      WHERE HORA BETWEEN #FechaIni# AND DATEADD(DAY,1,#FechaEnd#) AND DPTO = '400' AND SUBSTRING(NUMSERIE,1,2) LIKE #Sucursal#
      UNION
      SELECT
      'Conos cubierto' AS Articulo,
      CAST(SUM(ALBVENTALIN.TOTAL) AS DECIMAL(12,2)) AS TotalSales,
      COUNT(ALBVENTALIN.CODARTICULO) AS Orders
      FROM ALBVENTALIN
      INNER JOIN ARTICULOS ON ALBVENTALIN.CODARTICULO = ARTICULOS.CODARTICULO
      WHERE HORA BETWEEN #FechaIni# AND DATEADD(DAY,1,#FechaEnd#) AND DPTO = '500' AND SUBSTRING(NUMSERIE,1,2) LIKE #Sucursal#
      UNION
      SELECT
      'Royal Treats' AS Articulo,
      CAST(SUM(ALBVENTALIN.TOTAL) AS DECIMAL(12,2)) AS TotalSales,
      COUNT(ALBVENTALIN.CODARTICULO) AS Orders
      FROM ALBVENTALIN
      INNER JOIN ARTICULOS ON ALBVENTALIN.CODARTICULO = ARTICULOS.CODARTICULO
      WHERE HORA BETWEEN #FechaIni# AND DATEADD(DAY,1,#FechaEnd#) AND DPTO = '1500' AND SUBSTRING(NUMSERIE,1,2) LIKE #Sucursal#
      UNION
      SELECT
      'Cono Wafle' AS Articulo,
      CAST(SUM(ALBVENTALIN.TOTAL) AS DECIMAL(12,2)) AS TotalSales,
      COUNT(ALBVENTALIN.CODARTICULO) AS Orders
      FROM ALBVENTALIN
      INNER JOIN ARTICULOS ON ALBVENTALIN.CODARTICULO = ARTICULOS.CODARTICULO
      WHERE HORA BETWEEN #FechaIni# AND DATEADD(DAY,1,#FechaEnd#) AND DPTO IN ('600', '700') AND SUBSTRING(NUMSERIE,1,2) LIKE #Sucursal#
      UNION
      SELECT
      'Wafle Bowls' AS Articulo,
      CAST(SUM(ALBVENTALIN.TOTAL) AS DECIMAL(12,2)) AS TotalSales,
      COUNT(ALBVENTALIN.CODARTICULO) AS Orders
      FROM ALBVENTALIN
      INNER JOIN ARTICULOS ON ALBVENTALIN.CODARTICULO = ARTICULOS.CODARTICULO
      WHERE HORA BETWEEN #FechaIni# AND DATEADD(DAY,1,#FechaEnd#) AND DPTO = '300' AND SUBSTRING(NUMSERIE,1,2) LIKE #Sucursal#
      UNION
      SELECT
      'Pasteles' AS Articulo,
      CAST(SUM(ALBVENTALIN.TOTAL) AS DECIMAL(12,2)) AS TotalSales,
      COUNT(ALBVENTALIN.CODARTICULO) AS Orders
      FROM ALBVENTALIN
      INNER JOIN ARTICULOS ON ALBVENTALIN.CODARTICULO = ARTICULOS.CODARTICULO
      WHERE HORA BETWEEN #FechaIni# AND DATEADD(DAY,1,#FechaEnd#) AND DPTO = '1800' AND SECCION IN ('1801','1802','1803','1804') AND SUBSTRING(NUMSERIE,1,2) LIKE #Sucursal#
      UNION
      SELECT
      'Novelties' AS Articulo,
      CAST(SUM(ALBVENTALIN.TOTAL) AS DECIMAL(12,2)) AS TotalSales,
      COUNT(ALBVENTALIN.CODARTICULO) AS Orders
      FROM ALBVENTALIN
      INNER JOIN ARTICULOS ON ALBVENTALIN.CODARTICULO = ARTICULOS.CODARTICULO
      WHERE HORA BETWEEN #FechaIni# AND DATEADD(DAY,1,#FechaEnd#) AND DPTO = '800' AND SUBSTRING(NUMSERIE,1,2) LIKE #Sucursal#
      UNION
      SELECT
      'Sundaes' AS Articulo,
      CAST(SUM(ALBVENTALIN.TOTAL) AS DECIMAL(12,2)) AS TotalSales,
      COUNT(ALBVENTALIN.CODARTICULO) AS Orders
      FROM ALBVENTALIN
      INNER JOIN ARTICULOS ON ALBVENTALIN.CODARTICULO = ARTICULOS.CODARTICULO
      WHERE HORA BETWEEN #FechaIni# AND DATEADD(DAY,1,#FechaEnd#) AND DPTO = '1200' AND SUBSTRING(NUMSERIE,1,2) LIKE #Sucursal#
      UNION
      SELECT
      'Banana split' AS Articulo,
      CAST(SUM(ALBVENTALIN.TOTAL) AS DECIMAL(12,2)) AS TotalSales,
      COUNT(ALBVENTALIN.CODARTICULO) AS Orders
      FROM ALBVENTALIN
      INNER JOIN ARTICULOS ON ALBVENTALIN.CODARTICULO = ARTICULOS.CODARTICULO
      WHERE HORA BETWEEN #FechaIni# AND DATEADD(DAY,1,#FechaEnd#) AND ARTICULOS.CODARTICULO = '10204'AND SUBSTRING(NUMSERIE,1,2) LIKE #Sucursal#
      UNION
      SELECT
      'Blizzard Litro' AS Articulo,
      CAST(SUM(ALBVENTALIN.TOTAL) AS DECIMAL(12,2)) AS TotalSales,
      COUNT(ALBVENTALIN.CODARTICULO) AS Orders
      FROM ALBVENTALIN
      INNER JOIN ARTICULOS ON ALBVENTALIN.CODARTICULO = ARTICULOS.CODARTICULO
      WHERE HORA BETWEEN #FechaIni# AND DATEADD(DAY,1,#FechaEnd#) AND DPTO = '200' AND SUBSTRING(NUMSERIE,1,2) LIKE #Sucursal#
      UNION
      SELECT
      'Smoothie' AS Articulo,
      CAST(SUM(ALBVENTALIN.TOTAL) AS DECIMAL(12,2)) AS TotalSales,
      COUNT(ALBVENTALIN.CODARTICULO) AS Orders
      FROM ALBVENTALIN
      INNER JOIN ARTICULOS ON ALBVENTALIN.CODARTICULO = ARTICULOS.CODARTICULO
      WHERE HORA BETWEEN #FechaIni# AND DATEADD(DAY,1,#FechaEnd#) AND DPTO = '1100' AND SUBSTRING(NUMSERIE,1,2) LIKE #Sucursal#
      UNION
      SELECT
      'Artic' AS Articulo,
      CAST(SUM(ALBVENTALIN.TOTAL) AS DECIMAL(12,2)) AS TotalSales,
      COUNT(ALBVENTALIN.CODARTICULO) AS Orders
      FROM ALBVENTALIN
      INNER JOIN ARTICULOS ON ALBVENTALIN.CODARTICULO = ARTICULOS.CODARTICULO
      WHERE HORA BETWEEN #FechaIni# AND DATEADD(DAY,1,#FechaEnd#) AND DPTO = '1700' AND SUBSTRING(NUMSERIE,1,2) LIKE #Sucursal#
      UNION
      SELECT
      'Beverages' AS Articulo,
      CAST(SUM(ALBVENTALIN.TOTAL) AS DECIMAL(12,2)) AS TotalSales,
      COUNT(ALBVENTALIN.CODARTICULO) AS Orders
      FROM ALBVENTALIN
      INNER JOIN ARTICULOS ON ALBVENTALIN.CODARTICULO = ARTICULOS.CODARTICULO
      WHERE HORA BETWEEN #FechaIni# AND DATEADD(DAY,1,#FechaEnd#) AND DPTO = '900' AND SUBSTRING(NUMSERIE,1,2) LIKE #Sucursal#
      UNION
      SELECT
      'Extra Topping' AS Articulo,
      CAST(SUM(ALBVENTALIN.TOTAL) AS DECIMAL(12,2)) AS TotalSales,
      COUNT(ALBVENTALIN.CODARTICULO) AS Orders
      FROM ALBVENTALIN
      INNER JOIN ARTICULOS ON ALBVENTALIN.CODARTICULO = ARTICULOS.CODARTICULO
      WHERE HORA BETWEEN #FechaIni# AND DATEADD(DAY,1,#FechaEnd#) AND DPTO = '1900' AND SUBSTRING(NUMSERIE,1,2) LIKE #Sucursal#
      UNION
      SELECT
      'Cupones' AS Articulo,
      CAST(SUM(ALBVENTALIN.TOTAL) AS DECIMAL(12,2)) AS TotalSales,
      COUNT(ALBVENTALIN.CODARTICULO) AS Orders
      FROM ALBVENTALIN
      INNER JOIN ARTICULOS ON ALBVENTALIN.CODARTICULO = ARTICULOS.CODARTICULO
      WHERE HORA BETWEEN #FechaIni# AND DATEADD(DAY,1,#FechaEnd#) AND DPTO = '2000' AND SUBSTRING(NUMSERIE,1,2) LIKE #Sucursal#
      UNION
      SELECT
      '2x1' AS Articulo,
      CAST(SUM(CASE WHEN ALBVENTALIN.TOTAL > 0 THEN ALBVENTALIN.TOTAL ELSE 0 END) AS DECIMAL(12, 2)) AS TotalSales,
      COUNT(ALBVENTALIN.CODARTICULO) AS Orders
      FROM ALBVENTALIN
      INNER JOIN ARTICULOS ON ALBVENTALIN.CODARTICULO = ARTICULOS.CODARTICULO
      WHERE HORA BETWEEN #FechaIni# AND DATEADD(DAY,1,#FechaEnd#) AND ARTICULOS.CODARTICULO = '10547' AND SUBSTRING(NUMSERIE,1,2) LIKE #Sucursal#
    </select>
  </statements>
</sqlMap>
